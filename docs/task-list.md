# タスクリスト - 自然農法畑植生多様性解析ツール（iNatAg版）

## フェーズ1: 仕様確定・データ構造設計 (推定: 8-12時間) ✅

### 1.1 プロジェクト基盤構築 ✅
- [x] プロジェクト構造作成
- [x] **iNatAg版仕様書作成** (2,959種、470万画像対応)
- [x] **iNatAg対応タスクリスト作成**
- [x] 依存関係定義 (requirements.txt) - **Swin Transformer + LoRA対応**
- [x] 設定ファイル構造設計 (config.yaml) - **iNatAg設定追加**

### 1.2 データ構造設計 ✅
- [x] 入力データ形式定義 - **Swin Transformer 224x224対応**
- [x] 中間データ構造設計 - **iNatAg ID、LoRA情報追加**
- [x] 出力フォーマット詳細設計 - **2,959種対応**
- [x] データベーススキーマ設計（SQLite）
- [x] サンプルデータ作成

### 1.3 アーキテクチャ設計 ✅
- [x] クラス設計図作成 - **LoRAアダプター含む**
- [x] モジュール間インターフェース定義
- [x] エラーハンドリング戦略 - **LoRA関連エラー追加**
- [x] ログ設計

### 1.4 開発環境構築 ✅
- [x] Python環境セットアップ
- [x] 必要ライブラリインストール - **transformers, peft, timm追加**
- [x] テスト環境構築
- [x] CI/CD基盤準備

**フェーズ1完了基準:** ✅
- iNatAg対応設計ドキュメントが完成
- Swin Transformer + LoRA対応開発環境が構築済み
- 2,959種対応サンプルデータでの動作確認

---

## フェーズ2: 推論パイプライン（iNatAgモデル利用） (推定: 18-24時間)

### 2.1 画像前処理モジュール (推定: 7-9時間)
- [ ] 基本画像読み込み機能
- [ ] 明度・色温度補正実装 (CLAHE、ホワイトバランス、ガンマ補正)
- [ ] **Swin Transformer対応**: 224x224リサイズ、パッチ分割最適化
- [ ] **品質評価拡張**: ブラー、露出、ノイズ + Swin適合性評価
- [ ] 前処理パイプライン統合

### 2.2 類似度クラスタリング (推定: 4-5時間)
- [ ] SSIM類似度計算実装
- [ ] ヒストグラム類似度計算
- [ ] **階層クラスタリング実装**（Ward法）
- [ ] **代表画像選択ロジック**（品質スコア最高）
- [ ] 冗長性削減パイプライン

### 2.3 **iNatAg Swin Transformer統合** (推定: 5-7時間)
- [ ] **Hugging Face Hub接続**: Project-AgML/iNatAg-models
- [ ] **Swin Transformerモデル読み込み**: Tiny/Base/Large対応
- [ ] **推論パイプライン実装**: 2,959種分類対応
- [ ] **Top-k予測処理**: k=3、確信度付き
- [ ] **モデル選択機能**: 速度・精度要件に応じた自動選択

### 2.4 **LoRA微調整システム** (推定: 4-6時間)
- [ ] **LoRAアダプター実装**: peftライブラリ活用
- [ ] **北海道適応学習**: 畑画像での微調整パイプライン
- [ ] **LoRA設定管理**: rank=16、alpha=32、dropout=0.1
- [ ] **微調整実行機能**: 学習率1e-4、エポック10
- [ ] **適応効果評価**: 微調整前後の精度比較

### 2.5 **マルチモデル管理システム** (推定: 2-3時間)
- [ ] **マルチサイズ対応**: Tiny/Base/Large動的切り替え
- [ ] **信頼度評価システム**: 閾値ベース品質判定
- [ ] **LoRA適応状態管理**: 北海道特化モデルの管理
- [ ] **結果統合処理**: Top-3ソフト投票実装

**フェーズ2完了基準:**
- iNatAg Swin Transformerから2,959種識別結果を出力可能
- LoRA微調整による北海道適応が動作
- Tiny/Base/Large間の動的切り替えが動作
- Top-3ソフト投票による統合結果が出力可能

---

## フェーズ3: 多様性集計・補正ロジック実装 (推定: 14-18時間)

### 3.1 基本多様性指標 (推定: 4-5時間)
- [ ] **種リッチネス計算**（2,959種対応）
- [ ] Shannon多様度実装
- [ ] Pielou均等度実装
- [ ] Hill数（q=0,1,2）実装
- [ ] 指標統合クラス

### 3.2 高度な多様性指標 (推定: 5-6時間)
- [ ] **Chao1推定種数実装**（大規模種数対応）
- [ ] **カバレッジ標準化**（C*=0.8）
- [ ] **ブートストラップ信頼区間**（1000回反復）
- [ ] レアファクション曲線
- [ ] 種蓄積曲線

### 3.3 **Top-3ソフト投票システム** (推定: 3-4時間)
- [ ] **重み付き多様性計算**: Top-3予測の確信度重み付け
- [ ] **ソフト投票実装**: 確信度統合による多様性指標
- [ ] **分類学的ロールアップ**: 低確信度の属・科レベル統合
- [ ] **結果検証機能**: ハード投票との比較検証

### 3.4 **撮影枚数補正** (推定: 2-3時間)
- [ ] **サブサンプリング実装**: 固定30枚、反復1000回
- [ ] 反復平均計算
- [ ] 信頼区間算出
- [ ] バイアス補正機能

**フェーズ3完了基準:**
- 2,959種対応の全多様性指標が正確に計算される
- Top-3ソフト投票による重み付き多様性が算出される
- 撮影枚数の違いが適切に補正される
- 統計的信頼区間が算出される

---

## フェーズ4: JSON/CSV出力整備 (推定: 10-12時間)

### 4.1 **iNatAg対応JSON出力** (推定: 4-5時間)
- [ ] **日次サマリJSON構造実装**: iNatAg対応フォーマット
- [ ] **多様性指標フォーマット**: 2,959種対応
- [ ] **メタデータ付与**: モデル情報、LoRA適応状態、Swin Transformerサイズ
- [ ] **処理情報記録**: 推論時間、品質スコア
- [ ] **エラーハンドリング**: 大規模データ対応

### 4.2 **iNatAg対応CSV出力** (推定: 3-4時間)
- [ ] **詳細データCSV出力**: 画像単位結果
- [ ] **Top-3予測結果**: 種名、確信度、iNatAg ID
- [ ] **モデル情報記録**: 使用モデル、LoRA適応状態
- [ ] **ソフト投票結果**: 重み付き多様性スコア

### 4.3 **可視化データ準備** (推定: 3-3時間)
- [ ] **GitHub草風カレンダー用JSON**: 日次多様性スコア
- [ ] **時系列データ形式**: 多様性指標推移
- [ ] **統計サマリ生成**: 週次・月次集計
- [ ] **トレンド分析データ**: 季節変動パターン

**フェーズ4完了基準:**
- iNatAg完全対応の全出力形式が正常に生成される
- 2,959種対応データの整合性が保たれる
- LoRA適応情報が適切に記録される
- 後続可視化に適した形式で出力される

---

## フェーズ5: 可視化プロトタイプ（最低限UI） (推定: 12-16時間)

### 5.1 **GitHub草風カレンダー** (推定: 4-5時間)
- [ ] **日次多様性スコア可視化**: Shannon多様度ベース
- [ ] **カラーマッピング設定**: 多様性レベル別色分け
- [ ] **インタラクティブ機能**: 日付クリックで詳細表示
- [ ] **レスポンシブデザイン**: モバイル対応

### 5.2 **時系列可視化** (推定: 4-5時間)
- [ ] **多様性指標推移グラフ**: Shannon、Hill数、種リッチネス
- [ ] **信頼区間表示**: ブートストラップ結果の可視化
- [ ] **季節変動表示**: 月次・季節別パターン
- [ ] **比較機能**: 年次比較、期間比較

### 5.3 **iNatAg特化ダッシュボード** (推定: 4-6時間)
- [ ] **2,959種対応統計**: 種分布、頻度分析
- [ ] **北海道適応効果**: LoRA微調整前後比較
- [ ] **Swin Transformer性能**: モデルサイズ別精度・速度
- [ ] **Top-3ソフト投票結果**: 確信度分布、多様性寄与

**フェーズ5完了基準:**
- iNatAg対応の基本的な可視化機能が動作
- 2,959種データの直感的な理解が可能
- LoRA適応効果が視覚的に確認可能
- ユーザーフレンドリーなUI

---

## 追加タスク・品質保証

### **iNatAg特化テスト実装** (各フェーズ並行: 推定10-12時間)
- [ ] **単体テスト作成**: LoRA機能含む、カバレッジ80%以上
- [ ] **統合テスト実装**: エンドツーエンド、2,959種対応
- [ ] **性能テスト**: Swin Transformer各サイズ
- [ ] **精度検証テスト**: 北海道畑画像での検証
- [ ] **LoRA効果測定**: 微調整前後の定量評価

### **iNatAg対応ドキュメント整備** (推定: 5-7時間)
- [ ] **API仕様書**: iNatAg特化機能
- [ ] **LoRA微調整ガイド**: 北海道適応手順
- [ ] **モデル選択ガイド**: Tiny/Base/Large選択基準
- [ ] **トラブルシューティング**: iNatAg特有の問題対応

### **最適化・改善** (推定: 7-9時間)
- [ ] **処理速度最適化**: Swin Transformer推論高速化
- [ ] **メモリ使用量最適化**: 大規模モデル対応
- [ ] **LoRA効率化**: 微調整時間短縮
- [ ] **エラーハンドリング強化**: 2,959種対応

---

## 総推定時間: 76-98時間

### フェーズ別内訳:
- **フェーズ1**: 8-12時間 ✅ (完了 - iNatAg対応仕様確定・設計)
- **フェーズ2**: 18-24時間 (iNatAg + Swin Transformer + LoRA実装)
- **フェーズ3**: 14-18時間 (大規模種対応多様性解析)
- **フェーズ4**: 10-12時間 (iNatAg特化出力)
- **フェーズ5**: 12-16時間 (可視化プロトタイプ)
- **品質保証**: 14-16時間 (iNatAg特化テスト・ドキュメント・最適化)

### **iNatAg版の主要変更点**:
1. **モデル変更**: WeedNet → iNatAg Swin Transformer
2. **種数拡大**: 1,593種 → 2,959種（1.86倍の種カバレッジ）
3. **データセット規模**: 470万画像（大規模学習データ）
4. **アーキテクチャ**: Swin Transformer（最新Vision Transformer）
5. **地域適応**: LoRA微調整による北海道畑画像特化
6. **マルチサイズ対応**: Tiny/Base/Large動的選択
7. **ソフト投票**: Top-3確信度重み付き多様性計算
8. **学術的裏付け**: arXiv論文による技術的信頼性

### **技術的優位性**:
- **大規模データセット**: 470万画像、2,959種
- **最新アーキテクチャ**: Swin Transformer
- **効率的適応**: LoRA微調整による軽量な地域適応学習
- **柔軟性**: 処理速度・精度要件に応じたモデル選択
- **拡張性**: 他地域・他作物への展開可能性

### 重要な注意事項:
1. **iNatAgの利用可能性**: ✅ Hugging Face Hubで確認済み
2. **データ依存**: 実際の北海道畑画像データの品質により、LoRA微調整効果が変動
3. **性能要件**: GPU環境の有無により処理時間が大幅に変動（特にLargeモデル）
4. **専門知識**: 生態学的指標の正確な実装には専門文献の参照が必要
5. **LoRA学習**: 北海道適応用の畑画像データが必要

### 次のステップ:
1. **ユーザーによるiNatAg版仕様書・タスクリストの承認**
2. **フェーズ2の開始**: iNatAg推論パイプライン実装
3. **各フェーズ完了時の進捗報告・承認**

### 優先度:
1. **最高**: フェーズ2 (iNatAg推論パイプライン) - 核心技術
2. **高**: フェーズ3 (多様性解析) - 主要価値提供
3. **中**: フェーズ4 (出力機能) - 実用性確保
4. **低**: フェーズ5 (可視化) - ユーザビリティ向上

---

**文書バージョン**: 2.0（iNatAg版）  
**作成日**: 2025-08-24  
**更新日**: 2025-08-24  
**作成者**: Devin AI  
**ベースモデル**: iNatAg (Project-AgML/iNatAg-models)  
**対応種数**: 2,959種  
**データセット規模**: 470万画像
