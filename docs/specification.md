# 自然農法畑植生多様性解析ツール 仕様書

## 1. プロジェクト概要

### 1.1 目的
自然農法の畑の植生を撮影した画像から、雑草の種類と多様性を判定し、日ごとに時系列で可視化するツールを開発する。

### 1.2 目標
- 高精度な雑草種識別（WeedNet等の最新モデル活用）
- 生物多様性指標の正確な算出
- 撮影条件の違いに対する頑健性
- 拡張性を考慮したモジュール設計

### 1.3 対象ユーザー
- 自然農法実践者（一次利用者）
- 農業研究者（将来的な拡張対象）

## 2. 機能要件

### 2.1 入力仕様
- **データ形式**: JPEG画像ファイル
- **ディレクトリ構造**: `data/YYYY-MM-DD/*.jpg`
- **画像サイズ**: 任意（前処理で正規化）
- **撮影条件**: 屋外自然光、様々な天候・時間帯

### 2.2 前処理機能

#### 2.2.1 画像補正
- **明度補正**: ヒストグラム均等化、CLAHE適用
- **色温度補正**: ホワイトバランス調整
- **露出補正**: ガンマ補正による明暗調整

#### 2.2.2 冗長性削減
- **類似度計算**: 構造的類似性指数（SSIM）、特徴量ベース類似度
- **クラスタリング**: K-means、階層クラスタリング
- **代表画像選択**: クラスタ中心に最も近い画像を選択

### 2.3 推論機能

#### 2.3.1 第一候補: WeedNet
- **モデル**: WeedNet (2025年版、1,593種対応)
- **出力**: Top-k推定（k=3）
- **信頼度**: ソフトマックス確率値

#### 2.3.2 フォールバックモデル
- **候補**: iNatAg, AgriNet, DeepWeeds
- **転移学習**: LoRA（Low-Rank Adaptation）
- **ファインチューニング**: 軽微な追加学習

#### 2.3.3 推論後処理
- **信頼度フィルタリング**: 閾値以下は上位分類群にロールアップ
- **ソフト投票**: Top-3結果の重み付き平均

### 2.4 多様性評価機能

#### 2.4.1 基本指標
- **種リッチネス (R)**: ユニーク種数
- **Shannon多様度 (H')**: -Σ(pi × ln(pi))
- **Pielou均等度 (J)**: H' / ln(R)
- **Hill数**: q=0,1,2での多様度

#### 2.4.2 高度な指標
- **Chao1推定種数**: 未観測種の推定
- **カバレッジ標準化**: C*=0.8基準での標準化
- **信頼区間**: ブートストラップ法による区間推定

#### 2.4.3 撮影枚数補正
- **サブサンプリング**: 固定枚数mでの反復平均
- **レアファクション**: 種蓄積曲線による補正

### 2.5 出力機能

#### 2.5.1 日次サマリ (JSON)
```json
{
  "date": "2025-08-24",
  "species_richness": 15,
  "shannon_diversity": 2.34,
  "pielou_evenness": 0.86,
  "hill_numbers": {
    "q0": 15,
    "q1": 10.4,
    "q2": 8.2
  },
  "chao1_estimate": 18.5,
  "confidence_intervals": {
    "richness": [12, 18],
    "shannon": [2.1, 2.6]
  },
  "top_species": [
    {"name": "Taraxacum officinale", "abundance": 0.23, "confidence": 0.89},
    {"name": "Plantago major", "abundance": 0.18, "confidence": 0.92}
  ],
  "total_images": 45,
  "processed_images": 38
}
```

#### 2.5.2 詳細データ (CSV)
```csv
date,image_path,species_1,confidence_1,species_2,confidence_2,species_3,confidence_3
2025-08-24,data/2025-08-24/IMG_001.jpg,Taraxacum officinale,0.89,Plantago major,0.08,Trifolium repens,0.03
```

#### 2.5.3 可視化データ
- GitHub草風カレンダー用JSON
- 時系列グラフ用データ

## 3. 非機能要件

### 3.1 性能要件
- **処理速度**: 1画像あたり5秒以内
- **メモリ使用量**: 8GB以内
- **バッチ処理**: 100画像/日の処理能力

### 3.2 精度要件
- **種識別精度**: Top-1で70%以上、Top-3で85%以上
- **多様性指標精度**: 手動カウントとの相関係数0.8以上

### 3.3 拡張性要件
- **モジュール設計**: 各機能を独立したモジュールとして実装
- **設定ファイル**: YAML形式での設定管理
- **プラグイン対応**: 新しいモデルの容易な追加

## 4. システム構成

### 4.1 アーキテクチャ
```
Input Layer (画像データ)
    ↓
Preprocessing Layer (前処理)
    ↓
Model Layer (推論)
    ↓
Analysis Layer (多様性解析)
    ↓
Output Layer (結果出力)
```

### 4.2 主要コンポーネント
- **ImageProcessor**: 画像前処理
- **SpeciesClassifier**: 種識別
- **DiversityAnalyzer**: 多様性解析
- **OutputGenerator**: 結果出力
- **ConfigManager**: 設定管理

### 4.3 データフロー
1. 画像読み込み → 前処理 → 品質チェック
2. モデル推論 → 信頼度評価 → 結果統合
3. 多様性計算 → 統計処理 → 補正適用
4. 結果出力 → フォーマット変換 → ファイル保存

## 5. 技術仕様

### 5.1 開発環境
- **言語**: Python 3.12+
- **深層学習**: PyTorch 2.0+
- **画像処理**: OpenCV 4.8+
- **数値計算**: NumPy, SciPy
- **データ処理**: Pandas 2.0+

### 5.2 外部依存
- **WeedNet**: Hugging Face Hub経由
- **代替モデル**: TensorFlow Hub, PyTorch Hub
- **生態学ライブラリ**: scikit-bio, EcoSpold

### 5.3 設定管理
```yaml
# config.yaml
model:
  primary: "weednet"
  fallback: ["inatag", "agrinet"]
  confidence_threshold: 0.5

preprocessing:
  image_size: [224, 224]
  augmentation: true
  similarity_threshold: 0.85

diversity:
  bootstrap_iterations: 1000
  coverage_target: 0.8
  subsample_size: 30
```

## 6. 品質保証

### 6.1 テスト戦略
- **単体テスト**: 各モジュールの機能テスト
- **統合テスト**: エンドツーエンドの処理テスト
- **性能テスト**: 処理速度・メモリ使用量測定

### 6.2 検証方法
- **専門家による種同定結果との比較**
- **既知多様性データセットでの検証**
- **クロスバリデーション**

## 7. 運用・保守

### 7.1 ログ管理
- **処理ログ**: 各ステップの実行状況
- **エラーログ**: 例外・警告の記録
- **性能ログ**: 処理時間・リソース使用量

### 7.2 モニタリング
- **精度監視**: 定期的な精度評価
- **性能監視**: 処理時間の傾向分析
- **データ品質**: 入力画像の品質チェック

## 8. 将来拡張

### 8.1 機能拡張
- **他農地との比較機能**
- **季節変動解析**
- **病害虫検出機能**
- **土壌健康度推定**

### 8.2 技術拡張
- **リアルタイム処理**
- **モバイルアプリ対応**
- **クラウド展開**
- **API提供**

## 9. 制約事項

### 9.1 技術的制約
- **GPU要件**: CUDA対応GPU推奨
- **メモリ要件**: 最低8GB RAM
- **ストレージ**: モデルファイル用に5GB以上

### 9.2 データ制約
- **画像品質**: 最低解像度512x512
- **撮影条件**: 極端な逆光・暗所は除外
- **対象種**: 学習データに含まれる種のみ

## 10. 成功基準

### 10.1 技術的成功基準
- [ ] 種識別精度: Top-3で85%以上
- [ ] 処理速度: 1画像5秒以内
- [ ] 多様性指標の専門家評価との一致度80%以上

### 10.2 ユーザー満足度
- [ ] 使いやすいインターフェース
- [ ] 安定した動作
- [ ] 有用な洞察の提供

---

**文書バージョン**: 1.0  
**作成日**: 2025-08-24  
**作成者**: Devin AI  
**承認者**: ヤマシタ　ヤスヒロ
